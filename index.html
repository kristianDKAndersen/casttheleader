<!DOCTYPE html>
<html>
<head>
    <title>Chromecast Audio Sender</title>
 
    <style>
        .controls {
            margin: 20px;
            display: flex;
            flex-direction: column;
            align-items: start;
            gap: 10px;
        }
        button {
            padding: 10px 20px;
            margin: 5px;
        }
    </style>
</head>
<body>
    <div class="controls">
        <button id="castButton">Connect to Chromecast</button>
        <button id="playAudio" disabled>Play Audio</button>
        <button id="stopAudio" disabled>Stop</button>
    </div>
   
    <script type="text/javascript" src="https://www.gstatic.com/cv/js/sender/v1/cast_sender.js?loadCastFramework=1"></script>
    <script>
document.addEventListener('DOMContentLoaded', () => {
console.log("poop")
        const APP_ID = '64F29018';
        const NAMESPACE = 'urn:x-cast:com.screeninfo.app';
        const AUDIO_URL = 'https://casttheleader.vercel.app/silence15.mp3';
        
        let castSession = null;
        let currentMediaSession = null;
        let reloadTimer = null;

        const playButton = document.getElementById('playAudio');
        const stopButton = document.getElementById('stopAudio');
        const castButton = document.getElementById('castButton');


        // Function to reload m edia while maintaining playback position
        async function reloadMedia() {
    if (!castSession) {
        console.log('No cast session available.');
        return;
    }

    try {
        // Store current playback state
        const wasPlaying = currentMediaSession &&
            currentMediaSession.playerState === chrome.cast.media.PlayerState.PLAYING;
        const currentTime = currentMediaSession ? currentMediaSession.getEstimatedTime() : 0;

        // Create new media info
        const mediaInfo = new chrome.cast.media.MediaInfo(AUDIO_URL, 'audio/mp3');
        mediaInfo.metadata = new chrome.cast.media.MusicTrackMediaMetadata();
        mediaInfo.metadata.title = 'Background Audio';

        // Set starting position
        const request = new chrome.cast.media.LoadRequest(mediaInfo);
        request.currentTime = currentTime;

        // Load media and restore playback
        const mediaSession = await castSession.loadMedia(request);

        currentMediaSession = mediaSession;

        // If the media was playing before, resume playback
        if (wasPlaying) {
            await mediaSession.play();
        }
    } catch (error) {
        console.error('Error reloading media:', error);
    }
}


        
        const connectCast = async () => {
        console.log("clicked")
        return new Promise((resolve, reject) => {
      chrome.cast.requestSession(_session => {
        castSession = _session;
        if(castSession){
            stopButton.disabled = false;
            playButton.disabled = false;





            function sendActivityPing() {
                console.log("sendActivityPing function called")
                castSession = castContext.getCurrentSession();
            if (castSession) {
                
                console.log('Sending activity ping');

                castSession.sendMessage(NAMESPACE, {
                    type: 'activityPing',
                    timestamp: Date.now()
                });
            }else{
                console.log("wuut")
            }
        }

// Send activity ping every 8 minutes (before the 10-minute background trigger)
setInterval(sendActivityPing, 24000);



        }
      }, reject);
    });
        };



        // Function to start playback and reload timer
        async function startPlayback() {
    if (!castSession) {
        console.log('No cast session available.');
        return;
    }

    try {
        const mediaInfo = new chrome.cast.media.MediaInfo(AUDIO_URL, 'audio/mp3');
        mediaInfo.metadata = new chrome.cast.media.MusicTrackMediaMetadata();
        mediaInfo.metadata.title = 'Background Audio';

        const request = new chrome.cast.media.LoadRequest(mediaInfo);

        // Await the loadMedia method
        const mediaSession = await castSession.loadMedia(request);

        currentMediaSession = mediaSession;
        document.getElementById('playAudio').disabled = true;
        document.getElementById('stopAudio').disabled = false;

        // Start reload timer
        if (reloadTimer) {
            clearInterval(reloadTimer);
        }
        reloadTimer = setInterval(reloadMedia, 100000); // 30 seconds
    } catch (error) {
        console.error('Error loading media:', error);
    }
}


        // Function to stop playback and clear timer
        function stopPlayback() {
            if (currentMediaSession) {
                currentMediaSession.stop(null,
                    function() {
                        document.getElementById('playAudio').disabled = false;
                        document.getElementById('stopAudio').disabled = true;
                        
                        // Clear reload timer
                        if (reloadTimer) {
                            clearInterval(reloadTimer);
                            reloadTimer = null;
                        }
                    },
                    function(error) {
                        console.log('Error stopping: ' + error);
                    }
                );
            }
        }

        function initializeCastApi(){

         console.log('initializeCastApi')

            // Initialize Cast API
            const castContext = cast.framework.CastContext.getInstance();

            castContext.setOptions({
                receiverApplicationId: APP_ID,
                autoJoinPolicy: chrome.cast.AutoJoinPolicy.ORIGIN_SCOPED,
                });


            // Session management
            castContext.addEventListener(
                castContext.SESSION_STATE_CHANGED,
                event => {
                    switch(event.sessionState) {
                        case cast.framework.SessionState.castContext.SESSION_STARTED:
                        case cast.framework.SessionState.castContext.SESSION_RESUMED:
                            castSession = castContext.getCurrentSession();
                            document.getElementById('playAudio').disabled = false;
                            break;
                        case cast.framework.SessionState.castContext.SESSION_ENDED:
                            castSession = null;
                            currentMediaSession = null;
                            document.getElementById('playAudio').disabled = true;
                            document.getElementById('stopAudio').disabled = true;
                            if (reloadTimer) {
                                clearInterval(reloadTimer);
                                reloadTimer = null;
                            }
                            break;
                    }
                }
            );
          
  



            playButton.addEventListener('click', () => {
                console.log('Play button clicked');
                startPlayback();
            });

              stopButton.addEventListener('click', () => {
                console.log('Stop button clicked');
                stopPlayback();
            });

            castButton.addEventListener('click', () => {
                console.log('connectCast  button clicked');
                connectCast();
            });
            castButton.addEventListener('click', async () => {
                try {
                   

                } catch (error) {
                console.error('Cast error:', error);
                }
            }); 
      
        };
        console.log('before __onGCastApiAvailable')
        window['__onGCastApiAvailable'] = (loaded, errorInfo) => {
            
            if (loaded) {
            initializeCastApi();
            } else {
            console.error('Cast API load error:', errorInfo);
            }
        };
})



    </script>
</body>
</html>


<!-- 
<!DOCTYPE html>
<html lang="en">
<head>
    <link rel="icon" href="data:,">
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Cast the leader V1</title>


  <script src="https://cdn.tailwindcss.com"></script>
 <link rel="stylesheet" href="src/css/style.css">
 
 
 <script type="text/javascript" src="https://www.gstatic.com/cv/js/sender/v1/cast_sender.js?loadCastFramework=1"></script>



</head>
<body class="bg-SG_Blue">
    <div id="app" data-v-app="">
        <main class="mx-auto flex h-full w-full flex-col items-center p-5">
            <h1 class="text-white font-bold text-lg">Cast The leader V1</h1>
            <h2 class="statusTxt text-white font-bold text-lg">Cast API....</h2>
            
            <section class="flex flex-row w-full justify-evenly mt-2 mb-2 ">
                
                <div class="flex flex-row text-white items-center ">
                    <div role="button" class="addremove addInput rounded-full bg-white w-8 h-8 text-center text-black flex justify-center items-center font-bold mt-2 mb-2"> + </div>
                    <p class="ms-2">Add URL'S</p>
                    </div>
                    
                    <div role="button" id="castButton" class="relative addremove bg-white text-black p-2 rounded-lg mt-2 ">
                        <p>Connect to Cast</p>
                    </div>
                    <div role="button" id="stopcastButton" class="relative addremove bg-white text-black p-2 rounded-lg mt-2 ">
                        <p>Stop to Cast</p>
                    </div>
                    
            </section>
                    
                    
                    <section class="flex flex-col w-full theInputcontainer">
                            
                            <div class="flex flex-row justify-evenly items-center" style="order: 1;">
                                <input type="url" class="m-1 border bg-white rounded-lg p-2 w-5/6" placeholder="Enter URL (e.g., example.com)"  url="" data-id="index">
                                <div role="button" class="addremove rounded-full bg-white w-8 h-8 text-center text-black flex justify-center items-center font-bold"> - </div>
                            </div>
                        </section>
                        
                        <section class="flex flex-row w-full justify-between "></section>

                    </section></main></div>

  

<footer class="flex w-full flex-row items-center justify-center bg-green"><div id="dus">*</div></footer>
 <script type="module" src="main.js"></script>
</body>
</html>
-->