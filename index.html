<!DOCTYPE html>
<html>
<head>
    <title>Screen Info Sender</title>
    <script type="text/javascript" src="//www.gstatic.com/cv/js/sender/v1/cast_sender.js?loadCastFramework=1"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            background: #f5f5f5;
        }
        .control-panel {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        button {
            padding: 10px 20px;
            margin: 5px;
            background: #4285f4;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }
        button:disabled {
            background: #ccc;
        }
        #status, #screenInfo {
            padding: 15px;
            margin: 10px 0;
            background: white;
            border-radius: 4px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        #screenInfo {
            font-family: monospace;
            white-space: pre-wrap;
        }
        .info-item {
            margin: 5px 0;
            padding: 5px;
            border-bottom: 1px solid #eee;
        }
        .error {
            color: #d32f2f;
            background: #ffebee;
            padding: 10px;
            border-radius: 4px;
            margin: 10px 0;
        }
    </style>
</head>
<body>
    <div class="control-panel">
        <h2>Screen Info Cast Controller</h2>
        <button id="connectButton" onclick="connectToReceiver()">Connect to Chromecast</button>
        <button id="screenInfoButton" onclick="requestScreenInfo()" disabled>Get Screen Info</button>
        <button id="stopButton" onclick="stopCasting()" disabled>Stop Casting</button>
    </div>
    
    <div id="status">Initializing...</div>
    <div id="screenInfo"></div>

    <script>
        // Replace with your registered application ID from the Google Cast SDK Developer Console
        const APP_ID = '64F29018';
        const NAMESPACE = 'urn:x-cast:com.screeninfo.app';
        let castSession = null;
        let castContext = null;
        
        function updateStatus(message, isError = false) {
            console.log(message);
            const statusElement = document.getElementById('status');
            statusElement.textContent = message;
            statusElement.className = isError ? 'error' : '';
        }

        function updateButtonStates(isConnected) {
            document.getElementById('connectButton').disabled = isConnected;
            document.getElementById('screenInfoButton').disabled = !isConnected;
            document.getElementById('stopButton').disabled = !isConnected;
        }

        function displayScreenInfo(info) {
            const container = document.getElementById('screenInfo');
            let html = '<h3>Screen Information:</h3>';
            
            Object.entries(info).forEach(([key, value]) => {
                html += `<div class="info-item"><strong>${key}:</strong> ${value}</div>`;
            });
            
            container.innerHTML = html;
        }

        window['__onGCastApiAvailable'] = function(isAvailable) {
            if (isAvailable) {
                initializeCastApi();
            } else {
                updateStatus('Google Cast API is not available', true);
            }
        };

        function initializeCastApi() {
            try {
                castContext = cast.framework.CastContext.getInstance();
                castContext.setOptions({
                    receiverApplicationId: APP_ID,
                    autoJoinPolicy: chrome.cast.AutoJoinPolicy.ORIGIN_SCOPED,
                    language: 'en-US',
                    resumeSavedSession: false
                });

                // Add session listener
                castContext.addEventListener(
                    cast.framework.CastContextEventType.SESSION_STATE_CHANGED,
                    handleSessionStateChange
                );

                // Add error listener
                castContext.addEventListener(
                    cast.framework.CastContextEventType.CAST_STATE_CHANGED,
                    handleCastStateChange
                );

                updateStatus('Cast API initialized');
            } catch (error) {
                updateStatus(`Failed to initialize Cast API: ${error.message}`, true);
            }
        }

        function handleSessionStateChange(event) {
            switch (event.sessionState) {
                case cast.framework.SessionState.SESSION_STARTED:
                    castSession = castContext.getCurrentSession();
                    updateStatus('Connected to Chromecast');
                    updateButtonStates(true);
                    setupMessageListener();
                    break;
                case cast.framework.SessionState.SESSION_ENDED:
                    castSession = null;
                    updateStatus('Disconnected from Chromecast');
                    updateButtonStates(false);
                    document.getElementById('screenInfo').innerHTML = '';
                    break;
                case cast.framework.SessionState.SESSION_START_FAILED:
                    updateStatus('Failed to start session', true);
                    updateButtonStates(false);
                    break;
            }
        }

        function handleCastStateChange(event) {
            if (event.castState === cast.framework.CastState.NO_DEVICES_AVAILABLE) {
                updateStatus('No Chromecast devices found', true);
            }
        }

        function setupMessageListener() {
            if (!castSession) return;
            
            castSession.addMessageListener(NAMESPACE, (namespace, message) => {
                try {
                    const parsedMessage = typeof message === 'string' ? JSON.parse(message) : message;
                    if (parsedMessage.type === 'screenInfo') {
                        displayScreenInfo(parsedMessage.data);
                    }
                } catch (error) {
                    updateStatus(`Error processing message: ${error.message}`, true);
                }
            });
        }

        async function connectToReceiver() {
            updateStatus('Connecting to Chromecast...');
            try {
                await castContext.requestSession();
            } catch (error) {
                updateStatus(`Connection failed: ${error.message}`, true);
                updateButtonStates(false);
            }
        }

        async function requestScreenInfo() {
            if (!castSession) {
                updateStatus('Not connected to Chromecast', true);
                return;
            }

            try {
                await castSession.sendMessage(NAMESPACE, { command: 'getScreenInfo' });
                updateStatus('Screen info requested');
            } catch (error) {
                updateStatus(`Error requesting screen info: ${error.message}`, true);
            }
        }

        async function stopCasting() {
            if (!castSession) return;

            try {
                await castSession.endSession(true);
                updateStatus('Casting stopped');
                document.getElementById('screenInfo').innerHTML = '';
                updateButtonStates(false);
            } catch (error) {
                updateStatus(`Error stopping cast: ${error.message}`, true);
            }
        }
    </script>
</body>
</html>